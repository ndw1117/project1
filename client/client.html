<!DOCTYPE html>
<html lang="en">

<head>
  <title>Combs Quiz</title>
  <link rel="stylesheet" type="text/css" href="/style.css">

  <script>

    let score = 0;
    let numSongs = 8;
    let songList = [];
    const ctx = new AudioContext();


    const handleResponse = async (response, parseResponse) => {

      responseText = await response.text();
      console.log(responseText);

      const content = document.getElementById('content');
      content.innerHTML = '';

      // Display the information on the web page
      const h1 = document.createElement('h1');  // Code

      h1.innerText = response.headers.get('Status-Message');
      content.appendChild(h1);

      // If the response doesn't have a body to parse, return
      if (!parseResponse) {
        return;
      }

      const h3 = document.createElement('h3');  // Message

      if (response.ok && response.headers.get('Content-Type') === 'audio/mpeg') {
        return response;
      };

      let parsedData = JSON.parse(responseText);
      // If parsed data has a message
      if (parsedData.message) {
        h3.innerText = "Message: " + parsedData.message;
        content.appendChild(h3);
        return;
      }

      // If parsed data has a users object
      if (parsedData.users) {
        loadLeaderboard(parsedData.users);
        h3.innerText = JSON.stringify(parsedData.users);
        content.appendChild(h3);
        return;
      }

    };

    const sendFetchRequest = async (url, selectedMethod) => {

      // If it's a POST request
      if (selectedMethod === 'post') {

        const nameField = document.getElementById('nameField');

        const formData = `name=${nameField.value}&score=${score}`;

        const response = await fetch(url, {
          method: selectedMethod,
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json',
          },
          body: formData,
        });

        return handleResponse(response, response.status !== 204);
      }

      // Else it is a GET/HEAD request
      const response = await fetch(url, {
        method: selectedMethod,
        headers: {
          'Accept': 'application/json',
        }
      });

      return handleResponse(response, selectedMethod !== 'head');
    };

    const playAudio = (index = 0) => {
      const playSound = ctx.createBufferSource();
      playSound.buffer = songList[index];
      playSound.connect(ctx.destination);
      playSound.start(0, Math.floor(Math.random() * (playSound.buffer.duration - 21) + 1));

      setTimeout(() => {
        playSound.stop();
      }, 10 * 1000);
    };

    // This method's code was inspired by https://www.thecodecreative.com/blog/how-to-load-an-audio-file-using-fetch
    const loadAudio = async () => {

      for (let i = 0; i < numSongs; i++) {
        const response = await fetch(`/getAudio?id=${i}`, {
          method: 'get',
          headers: {
            'Accept': 'audio/mpeg',
          }
        });
        let arrayBuffer = await response.arrayBuffer();
        let decodedAudio = await ctx.decodeAudioData(arrayBuffer);
        console.log(decodedAudio); // decodedAudio.duration will give song length
        songList.push(decodedAudio);
      }

      console.log(songList);

    };


    const loadLeaderboard = (userJSON = null) => {
      const leaderboard = document.getElementById("leaderboard");

      leaderboard.innerHTML = `
      <tr>
        <th>Name</th>
        <th>Score</th>
      </tr>
      `;

      if (userJSON == null || Object.keys(userJSON).length === 0) {

        leaderboard.innerHTML += `
         <tr>
          <td colspan="2" style="text-align: center;">Be the first to top the charts!</td>
         </tr>
        </table>`;
        return;
      }

      // Else we have user data

      Object.keys(userJSON).forEach(user => {
        leaderboard.innerHTML += `
        <tr>
          <td>${userJSON[user]['name']}</td>
          <td>${userJSON[user]['score']}</td>
        </tr>`;
      });

      leaderboard.innerHTML += '</table>';

    };

    const init = () => {
      const startButton = document.getElementById("startButton");

      startButton.onclick = async () => {
        // sendFetchRequest('/addUser', 'post');
        // await sendFetchRequest('/getUsers', 'get');
        // sendFetchRequest('/getAudio', 'get');

        // Need the decimals to make sure 1st and last song have equal chance as the rest
        songNumber = Math.round(Math.random() * (songList.length - 0.02) - 0.49);
        playAudio(songNumber);
        console.log(`playing song number ${songNumber}`)
      };

      // When starting app, get user info and load the leaderboard
      sendFetchRequest('getUsers', 'get');

      // Load in the audio that will be used
      loadAudio();
    };

    window.onload = init;
  </script>
</head>

<body>
  <section id="top">
    <h1>Combs Quiz</h1>
    <table id="leaderboard">
      <tr>
        <th>Name</th>
        <th>Score</th>
      </tr>
      <tr>
        <td colspan="2" style="text-align: center;">Be the first to top the charts!</td>
      </tr>
    </table>
    <div id="nameDiv">
      <label for="nameField">Name: </label>
      <input type="text" id="nameField" name="nameField">
    </div>
    <button id="startButton">Start</button>
  </section>
  <section id="content">
  </section>
</body>

</html>